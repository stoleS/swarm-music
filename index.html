<!doctype html>
<html>

<head>
  <title>Socket.IO chat</title>
  <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/css/materialize.min.css">
  <style>
    .card-action {
      display: flex;
      justify-content: space-evenly;
      align-items: center;
    }

    .card-content {
      padding: 0 12px !important;
      display: flex;
      justify-content: center;
      flex-direction: column;
    }
    
    .s12 {
      display: flex;
      justify-content: center;
    }

    .card {
      width: 480px;
    }

    .collection-item.avatar {
      min-height: unset !important;
    }

    .collection {
      border: none;
    }

    .subtitle {
      color: #757575;
    }

    .modal-title {
      margin-bottom: 24px;
    }

    .close-btn {
      display: block;
      text-align: right;
    }

    .search-result {
      display: flex !important;
      cursor: pointer;
    }

    .song-info {
      padding-left: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .song-info h5 {
      color: #212121;
    }

    .song-info p {
      margin-top: 0;
      color: #757575;
    }

    .modal.bottom-sheet {
      max-height: 70% !important;
    }
  </style>
</head>

<body class="grey darken-4">
  <nav class="deep-purple darken-2">
    <div class="nav-wrapper">
      <form autocomplete="off" id="search-form">
        <div class="input-field">
          <input id="search" type="search" placeholder="Enter song name:" required>
          <label class="label-icon" for="search"><i class="material-icons">search</i></label>
          <i class="material-icons">close</i>
        </div>
      </form>
    </div>
  </nav>

  <div id="modal1" class="modal bottom-sheet">
    <div class="modal-content" id="search-content">
      <a href="#!" class="modal-close waves-effect waves-green btn-flat close-btn">Close</a>
      <ul class="collection" id="search-result">
      </ul>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <div class="col s12">
        <div class="card">
          <div class="card-image" id="player">
          </div>
          <div class="card-content">
            <input type="range" id="progress" value="0" min="0" max="100" />
            <h5 class="center-align" id="currently-playing"></h5>
          </div>
          <div class="card-action">

            <a class="btn-floating waves-effect waves-light light-blue"><i class="material-icons">shuffle</i></a>
            <a class="btn-floating btn-large waves-effect waves-light light-blue" onclick="toggleVideo()"><i class="
              material-icons">play_arrow</i></a>
            <a class="btn-floating waves-effect waves-light light-blue"><i class="material-icons">repeat_one</i></a>
          </div>
        </div>
      </div>
      <div class="col s12">
        <div class="card">
          <ul class="collection" id="queue-list">
            <nav class="deep-purple">
              <div class="nav-wrapper">
                <a href="#" class="brand-logo center">Queue:</a>
              </div>
            </nav>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/js/materialize.min.js"></script>
  <script>
    const socket = io();
    let recievedSongs = [];
    let currentlyPlaying = "";
    let returnedSong = [];
    let queue = [];
    let paused = false;

    // Server stream url
    const url = "http://192.168.1.6:4000/play";
    const audio = new Audio();

    // Get search value
    window.onkeyup = keyup;
    let inputValue;
    function keyup(e) {
      inputValue = e.target.value;
    }

    // Listen for search submit
    document.addEventListener("submit", e => {
      e.preventDefault();

      // Clean previous result list
      recievedSongs = [];

      // Clean returned song 
      returnedSong = [];

      // Clear input text
      document.getElementById("search-form").reset();

      // Remove previous search results
      const resultList = document.getElementById("search-result");
      if (resultList.hasChildNodes()) {
        while (resultList.hasChildNodes()) {
          resultList.removeChild(resultList.lastChild);
        }
      }

      const searchTerm = inputValue;
      socket.emit("search", {
        str: searchTerm
      });

      // Initialize modal and display it
      const Modalelem = document.querySelector('.modal');
      const instance = M.Modal.init(Modalelem);
      instance.open();
    });

    // Get selected song
    function selectedSong(e) {
      const selectedId = e.currentTarget.dataset.id;
      socket.emit("songChoice", {
        song: recievedSongs[selectedId]
      });
    }

    // Create queue item/s
    function createQueueItem(id, quantity, data) {
      // Parent
      const queueList = document.getElementById(id);

      // Create DOM elements
      for (let counter = 0; counter < quantity; counter++) {
        const li = document.createElement("li");
        li.dataset.id = counter;
        li.classList.add("collection-item", "avatar");

        const playButton = document.createElement("a");

        const playButtonIcon = document.createElement("i");
        playButtonIcon.classList.add("material-icons", "circle", "light-blue");
        const playIconName = document.createTextNode("play_arrow");
        playButtonIcon.appendChild(playIconName);

        const songTitle = document.createElement("span");
        songTitle.classList.add("title");
        const songTitleNode = document.createTextNode(data[0].title);
        songTitle.appendChild(songTitleNode);

        const subtitle = document.createElement("p");
        const subtitleTextNode = document.createTextNode(data[0].channel);
        subtitle.appendChild(subtitleTextNode);

        const deleteButton = document.createElement("a");
        deleteButton.classList.add("secondary-content");

        const deleteButtonIcon = document.createElement("i");
        deleteButtonIcon.classList.add("material-icons");
        const deleteIconName = document.createTextNode("delete");
        deleteButtonIcon.appendChild(deleteIconName);

        playButton.appendChild(playButtonIcon);
        deleteButton.appendChild(deleteButtonIcon);

        li.appendChild(playButton);
        li.appendChild(songTitle);
        li.appendChild(subtitle);
        li.appendChild(deleteButton);

        queueList.appendChild(li);
      }
    }

    ////////////////////////////////
    // SOCKET CALLS HANDLING START//
    ////////////////////////////////

    // Search results from the server
    socket.on("songSearch", data => {
      data.songs.forEach((song, i) => {
        // Add songs to result list
        recievedSongs.push(song);

        // Create DOM elements for search results
        const listItem = document.createElement("a");
        listItem.dataset.id = i;
        listItem.classList.add("collection-item", "search-result", "modal-close");

        const thumbnail = document.createElement("img");
        thumbnail.src = song.thumbnail_s;

        const songInfo = document.createElement("div");
        songInfo.classList.add("song-info");

        const songTitle = document.createElement("h5");
        const songTitleNode = document.createTextNode(song.title);
        songTitle.appendChild(songTitleNode);

        const songChannel = document.createElement("p");
        const songChannelNode = document.createTextNode(song.channel);
        songChannel.appendChild(songChannelNode);

        songInfo.appendChild(songTitle);
        songInfo.appendChild(songChannel);

        listItem.appendChild(thumbnail);
        listItem.appendChild(songInfo);

        document.getElementById("search-result").appendChild(listItem);
      });

      const songs = document.querySelectorAll(".search-result");
      songs.forEach(song => song.addEventListener("click", selectedSong))
    });

    // Get currently playing, queue and 
    // selected song from the server
    socket.on("addedSong", song => {
      returnedSong.push(song.song);
      queue = song.queue;
      currentlyPlaying = song.currentlyPlaying;

      const playing = document.getElementById("currently-playing");
      playing.innerHTML = currentlyPlaying;

      createQueueItem("queue-list", 1, returnedSong);

      createPlayer(song.song.id);
    });

    socket.on("playPause", data => {
      if (data.playing === true) {
        player.pauseVideo();
      } else {
        player.playVideo();
      }
    });

    socket.on("seekValue", data => {
      player.seekTo((player.getDuration() * offset) / 100, true);
    })
    ////////////////////////////////
    // SOCKET CALLS HANDLING END//
    ////////////////////////////////


    // 2. This code loads the IFrame Player API code asynchronously.
    var tag = document.createElement('script');

    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    // 3. This function creates an <iframe> (and YouTube player)
    //    after the API code downloads.
    var player;
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '270',
        width: '480',
        controls: 0,
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange
        },
        playerVars: {
          "controls": 0,
          "modestbranding": 1,
          "disablekb": 1
        }
      });
    }

    // 4. The API will call this function when the video player is ready.
    function onPlayerReady(event) {
      event.target.setVolume(40);
      event.target.playVideo();
    }

    var done = false;
    function onPlayerStateChange(event) {
      if (event.data == YT.PlayerState.ENDED) {
        console.log("end");
      }
    }

    function toggleVideo() {
      paused = !paused;
      socket.emit("toggle", {
        playing: paused
      })
    }

    function createPlayer(id) {
      player.loadVideoById(id);
    }

    // PROGRESS BAR
    let fraction = 0;
    let offset = 0;
    const thumb = document.querySelectorAll(".thumb");
    thumb[0].style.display = "none";
    const spanValue = document.querySelectorAll(".value");
    const progressBar = document.getElementById("progress");
    const value = document.getElementById("progress");

    progressBar.addEventListener("click", e => {
      offset = spanValue[0].textContent;
      socket.emit("seek", {
        value: offset
      })
    });

    setInterval(e => {
      if (player !== undefined) {
        if (player.getCurrentTime && player.getCurrentTime() !== 0) {
          fraction = player.getCurrentTime() / player.getDuration() * 100;
          value.value = fraction;
        }
      }
    }, 200);
  </script>
</body>

</html>