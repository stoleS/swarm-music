<!doctype html>
<html>

<head>
  <title>Socket.IO chat</title>
  <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/css/materialize.min.css">
  <style>
    .container {
      margin-top: 1rem;
    }

    .card-action {
      display: flex;
      justify-content: space-evenly;
      align-items: center;
    }

    .card-content {
      padding: 0 12px !important;
      display: flex;
      justify-content: center;
      flex-direction: column;
    }

    .col {
      height: 100%;
    }

    .player-col {
      display: flex;
      justify-content: flex-end;
    }
    
    .s12 {
      display: flex;
      justify-content: center;
    }

    .card {
      width: 480px;
    }

    .collection-item.avatar {
      min-height: unset !important;
    }

    .collection {
      border: none;
    }

    .subtitle {
      color: #757575;
    }

    #modal1 {
      background-color: #303030;
    }

    .modal-title {
      margin-bottom: 24px;
    }

    .close-btn {
      display: block;
      text-align: right;
      color: white;
    }

    .search-result {
      display: flex !important;
      cursor: pointer;
    }

    .song-info {
      padding-left: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .song-info h5 {
      color: white;
    }

    .song-info p {
      margin-top: 0;
      color: #9e9e9e;
    }

    #currently-playing {
      color: white; 
      margin: 1rem 0 2rem 0;
    }

    .modal.bottom-sheet {
      max-height: 70% !important;
    }

    i {
      color: #aeea00 !important;
    }

    li span {
      color: white;
    }

    .collection .collection-item.avatar p {
      color: #9e9e9e;
    }

    .queue-play, .secondary-content {
      cursor: pointer;
    }

    .collection .collection-item {
      border-bottom: 1px solid #303030;
    }

  </style>
</head>

<body style="background-color: #303030">
  <nav class="grey darken-4">
    <div class="nav-wrapper">
      <form autocomplete="off" id="search-form">
        <div class="input-field">
          <input id="search" type="search" placeholder="Enter song name:" required>
          <label class="label-icon" for="search"><i class="material-icons">search</i></label>
          <i class="material-icons">close</i>
        </div>
      </form>
    </div>
  </nav>

  <div id="modal1" class="modal bottom-sheet">
    <div class="modal-content" id="search-content">
      <a href="#!" class="modal-close waves-effect waves-green btn-flat close-btn">Close</a>
      <ul class="collection" id="search-result"></ul>
    </div>
  </div>

  <div class="row" style="margin-top: 1.5rem">
    <div class="col s6 player-col">
      <div class="card grey darken-3 z-depth-2">
        <div class="card-image" id="player">
        </div>
        <div class="card-content">
          <div class="progress grey darken-4">
            <div class="determinate lime accent-4" id="progress" style="width: 0%"></div>
          </div>
          <h5 class="center-align" id="currently-playing"></h5>
        </div>
        <div class="card-action">
          <a class="btn-floating waves-effect waves-light grey darken-4" onclick="back10s()" id="replay"><i class="material-icons">replay_10</i></a>
          <a class="btn-floating btn-large waves-effect grey darken-4" onclick="toggleVideo()"><i class="material-icons"
              style="font-size: 2.5rem" id="play-arrow">play_arrow</i></a>
          <a class="btn-floating waves-effect waves-light grey darken-4" onclick="forward10s()" id="forward"><i class="material-icons">forward_10</i></a>
        </div>
      </div>
    </div>
    <div class="col s6">
      <div class="card grey darken-3 z-depth-2">
        <nav class="grey darken-4">
          <div class="nav-wrapper">
            <a href="#" class="brand-logo center grey-text">Queue:</a>
          </div>
        </nav>
        <ul class="collection" id="queue-list" style="height: 100%"></ul>
      </div>
    </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/js/materialize.min.js"></script>
  <script>
    const socket = io();
    let streaming = false;
    let recievedSongs = [];
    let currentlyPlaying = "";
    let returnedSong = [];
    let queue = [];
    let paused = false;

    const playPauseIcon = document.getElementById("play-arrow");
    const playing = document.getElementById("currently-playing");


    // Server stream url
    const url = "http://192.168.1.6:4000/play";
    const audio = new Audio();

    // Get search value
    window.onkeyup = keyup;
    let inputValue;
    function keyup(e) {
      inputValue = e.target.value;
    }

    // Listen for search submit
    document.addEventListener("submit", e => {
      e.preventDefault();

      // Clean previous result list
      recievedSongs = [];

      // Clean returned song 
      returnedSong = [];

      // Clear input text
      document.getElementById("search-form").reset();

      // Remove previous search results
      const resultList = document.getElementById("search-result");
      if (resultList.hasChildNodes()) {
        while (resultList.hasChildNodes()) {
          resultList.removeChild(resultList.lastChild);
        }
      }

      const searchTerm = inputValue;
      socket.emit("search", {
        str: searchTerm
      });

      // Initialize modal and display it
      const Modalelem = document.querySelector('.modal');
      const instance = M.Modal.init(Modalelem);
      instance.open();
    });

    // Get selected song
    function selectedSong(e) {
      const selectedId = e.currentTarget.dataset.id;
      socket.emit("songChoice", {
        song: recievedSongs[selectedId]
      });
    }

    function playSong(e, songId) {
      queue.forEach(song => console.log(song.title));
      let id;
      let elementId;
      if (songId !== undefined) {
        id = queue.findIndex(song => song.id == songId);
        elementId = songId;
      } else {
        id = queue.findIndex(song => song.id == e.target.dataset.id);
        elementId = e.target.dataset.id;
      }
      console.log(id);
      socket.emit("newPlay", {
        id
      });
      player.loadVideoById(queue[id].id, 0, "large");
      currentlyPlaying = queue[id].title
      playing.textContent = currentlyPlaying;
      document.getElementById(elementId).remove();
      queue.splice(id, 1);
      queue.forEach(song => console.log(song.title));
    }

    function deleteSong(e) {
      const id = e.target.dataset.id;
      socket.emit("deleteSong", {
        songId: id
      });
      document.getElementById(id).remove();
    }


    ////////////////////////////////
    // SOCKET CALLS HANDLING START//
    ////////////////////////////////

    // Search results from the server
    socket.on("songSearch", data => {
      data.songs.forEach((song, i) => {
        // Add songs to result list
        createSearchResult(song, i);
      });

      const songs = document.querySelectorAll(".search-result");
      songs.forEach(song => song.addEventListener("click", selectedSong))
    });

    // Get currently playing, queue and 
    // selected song from the server
    socket.on("addedSong", song => {
      returnedSong.push(song.song);
      queue = song.queue;
      currentlyPlaying = song.currentlyPlaying;
      playing.innerHTML = currentlyPlaying;

      if (queue.length > 0) {
        createQueueItem("queue-list", 1, queue[queue.length - 1]);
      }

      if (streaming === false) {
        createPlayer(song.song.id);
        streaming = true;
      }
    });

    socket.on("playPause", data => {
      if (data.playing === true) {
        player.pauseVideo();
        paused = true;
        playPauseIcon.textContent = "play_arrow";
      } else {
        player.playVideo();
        paused = false;
        playPauseIcon.textContent = "pause";
      }
    });

    socket.on("seekDirection", data => {
      if (data.direction === "back") {
        back10s();
      } else if (data.direction === "forward") {
        forward10s();
      }
    });

    ////////////////////////////////
    // SOCKET CALLS HANDLING END//
    ////////////////////////////////    

    // 2. This code loads the IFrame Player API code asynchronously.
    var tag = document.createElement('script');

    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    // 3. This function creates an <iframe> (and YouTube player)
    //    after the API code downloads.
    var player;
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '270',
        width: '480',
        controls: 0,
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange
        },
        playerVars: {
          "controls": 0,
          "modestbranding": 1,
          "disablekb": 1
        }
      });
    }

    // 4. The API will call this function when the video player is ready.
    function onPlayerReady(event) {
      event.target.setVolume(100);
    }

    var done = false;
    function onPlayerStateChange(event) {
      if (event.data === 0 && queue.length > 0) {
        const firstInQueue = document.getElementById("queue-list").firstChild.id;
        console.log(firstInQueue);
        playSong(null, firstInQueue);
      }
    }

    // Seek functions
    function back10s() {
      player.seekTo(player.getCurrentTime() - 10, true);
    }

    function forward10s() {
      player.seekTo(player.getCurrentTime() + 10, true);
    }

    // Toggle play/pause
    function toggleVideo() {
      paused = !paused;
      socket.emit("toggle", {
        playing: paused
      })
    }

    function createPlayer(id) {
      player.loadVideoById(id);
      socket.emit("toggle", {
        playing: paused
      })
      playPauseIcon.textContent = "pause";
    }

    // PROGRESS BAR
    const value = document.getElementById("progress");

    setInterval(e => {
      if (player !== undefined) {
        if (player.getCurrentTime && player.getCurrentTime() !== 0) {
          fraction = player.getCurrentTime() / player.getDuration() * 100;
          value.style.width = fraction + "%";
          socket.emit("seekPosition", {
            value: fraction
          })
        }
      }
    }, 200);

    // Create search result elements
    function createSearchResult(song, i) {
      recievedSongs.push(song);

      // Create DOM elements for search results
      const listItem = document.createElement("a");
      listItem.dataset.id = i;
      listItem.classList.add("collection-item", "search-result", "modal-close", "grey", "darken-3");

      const thumbnail = document.createElement("img");
      thumbnail.src = song.thumbnail_s;

      const songInfo = document.createElement("div");
      songInfo.classList.add("song-info");

      const songTitle = document.createElement("h5");
      const songTitleNode = document.createTextNode(song.title);
      songTitle.appendChild(songTitleNode);

      const songChannel = document.createElement("p");
      const songChannelNode = document.createTextNode(song.channel);
      songChannel.appendChild(songChannelNode);

      songInfo.appendChild(songTitle);
      songInfo.appendChild(songChannel);

      listItem.appendChild(thumbnail);
      listItem.appendChild(songInfo);

      document.getElementById("search-result").appendChild(listItem);
    }

    // Create queue item/s
    function createQueueItem(id, quantity, data) {
      // Parent
      const queueList = document.getElementById(id);

      // Create DOM elements
      for (let counter = 0; counter < quantity; counter++) {
        const li = document.createElement("li");
        li.classList.add("collection-item", "avatar", "grey", "darken-3");
        li.id = data.id;

        const playButton = document.createElement("a");
        playButton.classList.add("queue-play");
        playButton.onclick = playSong;

        const playButtonIcon = document.createElement("i");
        playButtonIcon.classList.add("material-icons", "circle", "grey", "darken-4");
        const playIconName = document.createTextNode("play_arrow");
        playButtonIcon.appendChild(playIconName);
        playButtonIcon.dataset.id = data.id;

        const songTitle = document.createElement("span");
        songTitle.classList.add("title");
        const songTitleNode = document.createTextNode(data.title);
        songTitle.appendChild(songTitleNode);

        const subtitle = document.createElement("p");
        const subtitleTextNode = document.createTextNode(data.channel);
        subtitle.appendChild(subtitleTextNode);

        const deleteButton = document.createElement("a");
        deleteButton.classList.add("secondary-content");
        deleteButton.onclick = deleteSong;

        const deleteButtonIcon = document.createElement("i");
        deleteButtonIcon.classList.add("material-icons");
        const deleteIconName = document.createTextNode("delete");
        deleteButtonIcon.appendChild(deleteIconName);
        deleteButtonIcon.dataset.id = data.id;

        playButton.appendChild(playButtonIcon);
        deleteButton.appendChild(deleteButtonIcon);

        li.appendChild(playButton);
        li.appendChild(songTitle);
        li.appendChild(subtitle);
        li.appendChild(deleteButton);

        queueList.appendChild(li);
      }
    }
  </script>
</body>

</html>